<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Backflow Web - Taiko Mode</title>
        <link rel="stylesheet" href="../styles.css" />
        <link rel="stylesheet" href="taiko.css" />
        <script src="../script.js" defer></script>
    </head>
    <body>
        <!-- Service Button -->
        <button id="serviceButton" class="service-button">âš™</button>
        
        <!-- Service Popup -->
        <div id="servicePopup" class="service-popup">
            <div class="service-popup-content">
                <button class="service-btn" data-key="KEY_F1">Test</button>
                <button class="service-btn" data-key="KEY_F2">Service</button>
                <button class="service-btn" data-key="KEY_F3">Coin</button>
                <button class="service-btn" data-key="KEY_F4">Card</button>
            </div>
        </div>

        <!-- Drumhead area in center (first for priority) -->
        <div class="grid-container" data-section="taiko-drumhead">
            <div class="grid-row">
                <div class="grid-cell" data-key="KEY_X"></div>
                <div class="grid-cell" data-key="KEY_C"></div>
            </div>
        </div>

        <!-- Top rim area -->
        <div class="grid-container" data-section="taiko-rim-top">
            <div class="grid-row">
                <div class="grid-cell" data-key="KEY_Z"></div>
                <div class="grid-cell" data-key="KEY_V"></div>
            </div>
        </div>

        <!-- Bottom rim area -->
        <div class="grid-container" data-section="taiko-rim-bottom">
            <div class="grid-row">
                <div class="grid-cell" data-key="KEY_Z"></div>
                <div class="grid-cell" data-key="KEY_V"></div>
            </div>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                let serviceHoldTimer = null;
                let isServicePopupVisible = false;
                let touchStartTime = 0;
                let lastServiceButtonEvent = 0;
                
                const serviceButton = document.getElementById('serviceButton');
                const servicePopup = document.getElementById('servicePopup');
                const serviceButtons = document.querySelectorAll('.service-btn');

                // Handle both mouse and touch events for the service button
                serviceButton.addEventListener('mousedown', startServiceHold);
                serviceButton.addEventListener('mouseup', stopServiceHold);
                serviceButton.addEventListener('mouseleave', stopServiceHold);
                serviceButton.addEventListener('touchstart', startServiceHoldTouch, { passive: false });
                serviceButton.addEventListener('touchend', stopServiceHoldTouch, { passive: false });
                serviceButton.addEventListener('touchcancel', stopServiceHoldTouch, { passive: false });
                
                function startServiceHold(event) {
                    event.preventDefault();
                    serviceHoldTimer = setTimeout(() => {
                        showServicePopup();
                    }, 1000);
                }
                
                function startServiceHoldTouch(event) {
                    event.preventDefault();
                    touchStartTime = Date.now();
                    serviceHoldTimer = setTimeout(() => {
                        showServicePopup();
                    }, 1000);
                }
                
                function stopServiceHold(event) {
                    event.preventDefault();
                    if (serviceHoldTimer) {
                        clearTimeout(serviceHoldTimer);
                        serviceHoldTimer = null;
                    }
                }
                
                function stopServiceHoldTouch(event) {
                    event.preventDefault();
                    if (serviceHoldTimer) {
                        clearTimeout(serviceHoldTimer);
                        serviceHoldTimer = null;
                    }
                    touchStartTime = 0;
                }
                
                function showServicePopup() {
                    isServicePopupVisible = true;
                    servicePopup.classList.add('show');
                    console.log('ðŸ”§ Service popup shown');
                }
                
                function hideServicePopup() {
                    isServicePopupVisible = false;
                    servicePopup.classList.remove('show');
                    console.log('ðŸ”§ Service popup hidden');
                }
                
                // Utility: detect iOS PWA
                function isIOSPWA() {
                    return (
                        window.navigator.standalone === true ||
                        (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches)
                    ) && /iphone|ipad|ipod/i.test(window.navigator.userAgent);
                }
                const iospwa = isIOSPWA();
                
                // Handle both click and touch events for hiding popup
                function handleOutsideInteraction(event) {
                    if (isServicePopupVisible && 
                        !servicePopup.contains(event.target) && 
                        !serviceButton.contains(event.target)) {
                        hideServicePopup();
                    }
                }
                
                if (iospwa) {
                    document.addEventListener('touchstart', handleOutsideInteraction, { passive: true });
                } else {
                    document.addEventListener('click', handleOutsideInteraction);
                    document.addEventListener('touchstart', handleOutsideInteraction, { passive: true });
                }
                
                serviceButtons.forEach(button => {
                    // Handle both click and touch events for service buttons
                    function handleServiceButtonPress(event) {
                        event.preventDefault();
                        event.stopPropagation();
                        // Prevent double firing on iOS (touchend + click)
                        const now = Date.now();
                        if (now - lastServiceButtonEvent < 350) return;
                        lastServiceButtonEvent = now;

                        const key = event.target.dataset.key;
                        console.log('ðŸ”§ Service button pressed:', key);

                        if (key && window.gridController) {
                            window.gridController.webSocketHandler.sendKeyboardEvent(key, true, "service-menu");
                            setTimeout(() => {
                                window.gridController.webSocketHandler.sendKeyboardEvent(key, false, "service-menu");
                            }, 100);
                        } else if (key) {
                            console.warn('Service button clicked but gridController not available:', key);
                        }
                        hideServicePopup(); // Hide immediately
                    }
                    if (iospwa) {
                        button.addEventListener('touchend', handleServiceButtonPress, { passive: false });
                    } else {
                        button.addEventListener('click', handleServiceButtonPress);
                        button.addEventListener('touchend', handleServiceButtonPress, { passive: false });
                    }
                });
                
                console.log('ðŸ”§ Service menu initialized for iOS Safari compatibility');
            });
        </script>
    </body>
</html>
